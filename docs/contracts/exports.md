# Export Operations API Contract

## Overview

The Export Operations API enables generation and download of caption files, transcripts, and translated content in various formats. Following the JS-first architecture, JavaScript orchestrates export workflows while Python handles file generation and processing.

## REST Endpoints

### Export Session Data

**POST** `/api/sessions/{session_id}/export`

Generates export files from session transcription and translation data.

#### Request
```typescript
interface ExportRequest {
  formats: ExportFormat[]           // Output formats to generate
  content_types: ContentType[]      // What content to include  
  options: ExportOptions            // Format-specific options
  filename_template?: string        // Custom filename pattern
}

type ExportFormat = 
  | 'srt'          // SubRip Subtitle format
  | 'vtt'          // WebVTT format
  | 'txt'          // Plain text transcript
  | 'json'         // Structured JSON export
  | 'csv'          // Comma-separated values
  | 'docx'         // Microsoft Word document

type ContentType =
  | 'transcription'  // Original transcribed text
  | 'translation'    // Translated text
  | 'both'          // Both transcription and translation
  | 'metadata'      // Timing, confidence scores, etc.

interface ExportOptions {
  include_timestamps?: boolean      // Include timing information
  include_confidence?: boolean      // Include confidence scores
  include_speaker_labels?: boolean  // Include speaker identification
  merge_segments?: boolean         // Combine short segments
  max_line_length?: number         // Character limit per line
  language_labels?: boolean        // Label original vs translated
  custom_metadata?: Record<string, any>  // Additional metadata
}
```

```json
{
  "formats": ["srt", "txt", "json"],
  "content_types": ["both"],
  "options": {
    "include_timestamps": true,
    "include_confidence": true,
    "merge_segments": true,
    "max_line_length": 80,
    "language_labels": true
  },
  "filename_template": "session_{session_id}_{timestamp}_{format}"
}
```

#### Response
```typescript
interface ExportResponse {
  export_id: string
  status: 'queued' | 'processing' | 'completed' | 'failed'
  files: ExportFile[]
  estimated_completion_ms?: number
}

interface ExportFile {
  format: ExportFormat
  content_type: ContentType  
  filename: string
  size_bytes?: number
  download_url?: string        // Available when completed
  preview_url?: string         // For text formats
}
```

```json
{
  "export_id": "export_1705123456_xyz789",
  "status": "processing",
  "files": [
    {
      "format": "srt",
      "content_type": "both", 
      "filename": "session_sess123_20240113_143022_srt"
    },
    {
      "format": "txt",
      "content_type": "both",
      "filename": "session_sess123_20240113_143022_txt"
    },
    {
      "format": "json",
      "content_type": "both",
      "filename": "session_sess123_20240113_143022_json"
    }
  ],
  "estimated_completion_ms": 2500
}
```

### Get Export Status

**GET** `/api/exports/{export_id}`

Retrieves status and details of an export operation.

#### Response
```typescript
interface ExportStatus extends ExportResponse {
  session_id: string
  created_at: string           // ISO8601
  started_at?: string          // ISO8601
  completed_at?: string        // ISO8601
  progress: number             // 0-100 percentage
  error_message?: string
  stats: {
    total_segments: number
    total_characters: number
    total_duration_ms: number
    languages: string[]
  }
}
```

### Download Export File

**GET** `/api/exports/{export_id}/files/{filename}`

Downloads a specific exported file.

#### Response
- **Content-Type**: Varies by format (`text/plain`, `application/json`, etc.)
- **Content-Disposition**: `attachment; filename="..."`
- **Content-Length**: File size in bytes

### List Session Exports

**GET** `/api/sessions/{session_id}/exports`

Lists all export operations for a session.

#### Query Parameters
- `status?`: Filter by status
- `format?`: Filter by output format
- `limit?`: Maximum results (default: 20)
- `offset?`: Pagination offset

#### Response
```typescript
interface ExportListResponse {
  exports: ExportSummary[]
  total: number
  has_more: boolean
}

interface ExportSummary {
  export_id: string
  status: string
  formats: ExportFormat[]
  created_at: string
  file_count: number
  total_size_bytes: number
}
```

## Export Formats

### SubRip (SRT) Format
```srt
1
00:00:00,000 --> 00:00:03,500
Hello, welcome to the presentation.
[ZH] 你好，欢迎参加演示。

2
00:00:03,500 --> 00:00:07,200
Today we'll discuss machine learning.
[ZH] 今天我们将讨论机器学习。
```

### WebVTT Format
```vtt
WEBVTT

NOTE Generated by LoquiLex v0.1.0

00:00.000 --> 00:03.500
Hello, welcome to the presentation.
[ZH] 你好，欢迎参加演示。

00:03.500 --> 00:07.200
Today we'll discuss machine learning.
[ZH] 今天我们将讨论机器学习。
```

### Plain Text Format
```text
LoquiLex Session Transcript
Generated: 2024-01-13T14:30:22Z
Session: sess_1234567890abcdef
Duration: 00:45:23

[00:00] Hello, welcome to the presentation.
[00:00] [ZH] 你好，欢迎参加演示。

[00:03] Today we'll discuss machine learning.
[00:03] [ZH] 今天我们将讨论机器学习。
```

### JSON Format
```json
{
  "export_metadata": {
    "session_id": "sess_1234567890abcdef",
    "exported_at": "2024-01-13T14:30:22Z",
    "loquilex_version": "0.1.0",
    "total_duration_ms": 2723000
  },
  "segments": [
    {
      "id": "seg_001",
      "start_ms": 0,
      "end_ms": 3500,
      "transcription": {
        "text": "Hello, welcome to the presentation.",
        "language": "en",
        "confidence": 0.96
      },
      "translation": {
        "text": "你好，欢迎参加演示。",
        "language": "zh", 
        "confidence": 0.91
      }
    }
  ]
}
```

### CSV Format
```csv
segment_id,start_ms,end_ms,original_text,original_lang,translated_text,translated_lang,confidence_original,confidence_translation
seg_001,0,3500,"Hello, welcome to the presentation.",en,"你好，欢迎参加演示。",zh,0.96,0.91
seg_002,3500,7200,"Today we'll discuss machine learning.",en,"今天我们将讨论机器学习。",zh,0.94,0.89
```

## WebSocket Events

Export operations provide real-time status updates via WebSocket.

### Export Started

```json
{
  "v": 1,
  "t": "export.started",
  "sid": "sess_1234567890abcdef",
  "data": {
    "export_id": "export_1705123456_xyz789",
    "session_id": "sess_1234567890abcdef",
    "formats": ["srt", "txt", "json"],
    "estimated_completion_ms": 2500
  }
}
```

### Export Progress

```json
{
  "v": 1,
  "t": "export.progress",
  "sid": "sess_1234567890abcdef",
  "data": {
    "export_id": "export_1705123456_xyz789",
    "progress": 65,
    "current_operation": "generating_srt",
    "files_completed": 1,
    "files_total": 3
  }
}
```

### Export Completed

```json
{
  "v": 1,
  "t": "export.completed",
  "sid": "sess_1234567890abcdef",
  "data": {
    "export_id": "export_1705123456_xyz789",
    "files": [
      {
        "format": "srt",
        "filename": "session_sess123_20240113_143022.srt",
        "size_bytes": 1024,
        "download_url": "/api/exports/export_1705123456_xyz789/files/session_sess123_20240113_143022.srt"
      }
    ],
    "total_size_bytes": 3072,
    "duration_ms": 2150
  }
}
```

### Export Failed

```json
{
  "v": 1,
  "t": "export.failed", 
  "sid": "sess_1234567890abcdef",
  "data": {
    "export_id": "export_1705123456_xyz789",
    "error_code": "INSUFFICIENT_DATA",
    "error_message": "Session contains no transcription data to export",
    "failed_at_format": "srt"
  }
}
```

## Error Handling

### HTTP Status Codes
- **200**: Success
- **202**: Export queued/processing
- **400**: Invalid request (unsupported format, empty session)
- **404**: Export ID or session not found
- **409**: Export already in progress for session
- **413**: Session data too large for export
- **422**: Unsupported format combination
- **507**: Insufficient disk space for export

### Common Error Codes
- `INSUFFICIENT_DATA`: Session has no transcription data
- `UNSUPPORTED_FORMAT_COMBINATION`: Invalid format + content combination
- `FILE_SIZE_LIMIT_EXCEEDED`: Export would exceed size limits
- `EXPORT_TIMEOUT`: Processing exceeded maximum duration
- `DISK_SPACE_ERROR`: Not enough storage for temporary files
- `TEMPLATE_ERROR`: Invalid filename template
- `ENCODING_ERROR`: Character encoding issues

## File Management

### Storage and Cleanup
- Export files stored in session-specific directories
- Files automatically deleted after 24 hours
- Maximum 100MB total exports per session
- Concurrent export limit: 3 per session

### Download URLs
- Temporary signed URLs valid for 1 hour
- Direct download without authentication
- Content-Disposition header for proper filename handling
- Support for Range requests (partial downloads)

## Integration Examples

### TypeScript Client
```typescript
import { ExportsAPI } from '../api/exports'

const exportsAPI = new ExportsAPI()

// Start export
const exportResponse = await exportsAPI.createExport(sessionId, {
  formats: ['srt', 'json'],
  content_types: ['both'],
  options: {
    include_timestamps: true,
    include_confidence: true
  }
})

// Monitor progress
websocket.on('export.completed', (envelope) => {
  const { files } = envelope.data
  files.forEach(file => {
    downloadExportFile(file.download_url, file.filename)
  })
})
```

### Python Backend
```python
from loquilex.exports import ExportManager
from loquilex.api.server import ExportRequest

@app.post("/api/sessions/{session_id}/export")
async def create_export(session_id: str, request: ExportRequest):
    export_manager = ExportManager()
    export_id = await export_manager.start_export(
        session_id=session_id,
        formats=request.formats,
        content_types=request.content_types,
        options=request.options
    )
    return {"export_id": export_id, "status": "queued"}
```

## Testing Contracts

### Mock Export Data
```typescript
const mockSessionData = {
  segments: [
    {
      id: 'seg_001',
      start_ms: 0,
      end_ms: 3500,
      transcription: { text: 'Hello world', language: 'en' },
      translation: { text: '你好世界', language: 'zh' }
    }
  ]
}

const expectedSRTOutput = `1
00:00:00,000 --> 00:00:03,500
Hello world
[ZH] 你好世界`
```

### Format Validation Tests
```python
@pytest.mark.parametrize("format,content", [
    ("srt", "subtitles"),
    ("vtt", "captions"),
    ("txt", "transcript"),
    ("json", "structured")
])
def test_export_format_generation(format, content):
    # Test each export format
    pass
```

## Performance Considerations

### Large Session Handling
- Streaming export for sessions > 10MB
- Chunked processing for long sessions (>4 hours)
- Background processing queue with priority levels
- Progress updates every 500ms during processing

### Memory Management
- Process segments in batches of 1000
- Temporary file cleanup on errors
- Maximum memory usage: 100MB per export operation
- Compression for large JSON exports

## Security

### Access Control
- Export operations require session ownership
- Download URLs are temporary and session-scoped
- No sensitive data in exported metadata
- Audit logging for all export operations

### Data Privacy
- No user identification in export files
- Optional data redaction for sensitive content
- Secure deletion of temporary processing files
- Export history limited to session duration